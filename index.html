<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <style>
        html{
            font-family: "Open Sans";
            font-style: normal;
            font-variant: normal;
            font-weight: 500;
            color: #333;
            background: #f5f5f5;
        }
        .row{
            clear: both;
            overflow: hidden;
        }
        h1{
            color: #333;
        }
        h2{
            color: #999;
            padding: 5px;
            line-height: 1.5em;
            margin: 0;
        }
        p{
            text-align: center;
        }
        #table table{
            width: 90%;
            margin: auto;
        }
        #counter_table{
            float: left;
        }
        #counter_table table{
            width: 500px;
            margin-right: 50px;
            margin-top: 40px;
            margin-left: 20px;
        }
        thead tr{
            color: #999;
        }
        tbody tr{
            height: 40px;

        }
        tbody td{
            border-bottom: 1px solid #f5f5f5;
        }
        td .legend{
            border-radius: 50%;
            height: 20px;
            width: 20px;
            display: block;
        }
        th.value{
            width: 30px;
        }
        th{
            text-transform: uppercase;
            font-size: 12px;
            text-align: left;
        }
        .main{
            width: 900px;
            margin: auto;
        }
        .y.axis .tick line {
            stroke-width: 1;
            stroke: rgba(0, 0, 0, 0.2);
        }
        .y.axis path.domain{
            stroke: none;
        }
        rect:hover {
            fill: orange !important;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<div class="main">
    <h1>Dashboard</h1>

    <!-- We will add the donut and table here -->
    <h2>Total value</h2>
    <div class="row">
        <div id="counter_table"></div>
        <div id="today"></div>
    </div>

    <!-- We will add barchart here -->
    <h2>Sales every month</h2>
    <div class="row">
        <div id="month">
        </div>
    </div>

    <!-- We will add the data table here -->
    <h2>Data</h2>
    <div class="row">
        <div id="table">
        </div>
    </div>

</div>

<script>

    data =
        [
            {year: "2013-01", value: 53,  category: "pants"},
            {year: "2013-02", value: 165, category: "pants"},
            {year: "2013-03", value: 269, category: "pants"},
            {year: "2013-04", value: 344, category: "pants"},
            {year: "2013-05", value: 376, category: "shirt"},
            {year: "2013-06", value: 410, category: "shirt"},
            {year: "2013-07", value: 421, category: "shirt"},
            {year: "2013-08", value: 405, category: "shirt"},
            {year: "2013-09", value: 376, category: "shirt"},
            {year: "2013-10", value: 359, category: "shoes"},
            {year: "2013-11", value: 392, category: "shoes"},
            {year: "2013-12", value: 433, category: "shoes"},
            // {year: "2014-01", value: 455, category: "shoes"},
            // {year: "2014-02", value: 478, category: "shoes"},
            // {year: "2014-03", value: 269, category: "pants"},
            // {year: "2014-04", value: 344, category: "pants"},
            // {year: "2014-05", value: 376, category: "shirt"},
            // {year: "2014-06", value: 410, category: "shirt"},
            // {year: "2014-07", value: 421, category: "shirt"},
            // {year: "2014-08", value: 405, category: "shirt"},
            // {year: "2014-09", value: 376, category: "shirt"},
            // {year: "2014-10", value: 359, category: "shoes"},
            // {year: "2014-11", value: 392, category: "shoes"},
            // {year: "2014-12", value: 433, category: "shoes"},
            // {year: "2015-01", value: 455, category: "shoes"},
            // {year: "2015-02", value: 478, category: "shoes"},
            // {year: "2015-03", value: 269, category: "pants"},
            // {year: "2015-04", value: 344, category: "pants"},
            // {year: "2015-05", value: 376, category: "shirt"},
            // {year: "2015-06", value: 410, category: "shirt"},
            // {year: "2015-07", value: 421, category: "shirt"},
            // {year: "2015-08", value: 405, category: "shirt"},
            // {year: "2015-09", value: 376, category: "shirt"},
            // {year: "2015-10", value: 359, category: "shoes"},
            // {year: "2015-11", value: 392, category: "shoes"},
            // {year: "2015-12", value: 433, category: "shoes"},
        ];

    var dateParser   = d3.timeParse('%Y-%m')
    var dateFormatter = d3.timeFormat('%Y-%m')

    data.forEach(function(d) {
        d.date = dateParser(d.year);
        d.value = +d.value;
    });

    var table = d3.select('#table').append('table');
    var thead = table.append('thead').append('tr');

    thead.append('th').text('date');
    thead.append('th').text('category');
    thead.append('th').text('class', 'value').text('value');

    var tbody = table.append('tbody');
    var tr    = tbody.selectAll('tr')
        .data(data).enter()
        .append('tr');

    tr.append('td').html((d) => dateFormatter(d.date))
    tr.append('td').html((d) => d.category)
    tr.append('td').html((d) => d.value)

    var graphMargin = {
        top:    20,
        right:  20,
        bottom: 70,
        left:   40
    }
    var graphWidth  = 600 - graphMargin.left - graphMargin.right;
    var graphHeight = 300 - graphMargin.top  - graphMargin.bottom;

    /*
     * PI CHART
    */

    // Define donut size
    const DONUT_WIDTH  = 250;
    const DONUT_HEIGHT = 250;
    const DONUT_RADIUS = 125;

    // Set some noice colors
    var color = d3.scaleOrdinal().range(['#C5FFB3', '#4EE1FF', '#9232FF'])

    // Structure by category
    // Creating 3 key value pairs: { category, totalValue }
    // Using d3 sum helper to reduce specific values into one for each category
    function groupByCategory(data) {
        return d3
        .nest()
        .key( (d) => d.category )
        .sortKeys(d3.ascending)
        .rollup( (v) => d3.sum(v, (d) => d.value) )
        .entries(data);
    }

    // Create a table
    // Get the html element
    var counterTable = d3.select('#counter_table').append('table');
    // Set the header
    var counterTHead = counterTable.append('thead').append('tr');
    counterTHead.append('th').text('category');
    counterTHead.on('click', drawDonut.bind(this, data))
    counterTHead.append('th').attr('class', 'value').text('value');
    // Set the body
    var counterTBody = counterTable.append('tbody');
    // Use D3 to render tr elements for each data entry
    var counterTR    = counterTBody.selectAll('tr')
        .data(groupByCategory(data)).enter()
        .append('tr')
    counterTR.append('td').html((d) => d.key);
    counterTR.append('td').html((d) => d.value);
    counterTR.style('background', (d) => color(d.key));
    counterTR.on('click', catClicked);

    function catClicked(e) {
        // Get category
        if(e.key) {
            console.log(e.key);
            drawChart(data.filter( (d) => d.category !== e.key ))
            drawDonut(data.filter( (d) => d.category !== e.key ))
        }
        if(e.data) {
            console.log(e.data.key);
            drawChart(data.filter( (d) => d.category !== e.data.key ))
            drawDonut(data.filter( (d) => d.category !== e.data.key ))
        }
    }

    function drawChart(data) {
        if(d3.select('#month').selectAll('#svg')) {
            d3.select('#barchart').remove()
        }
        var svg = d3.select('#month').append('svg')
            .attr('id', 'barchart')
            .attr('width',  graphWidth  + graphMargin.left + graphMargin.right)
            .attr('height', graphHeight + graphMargin.top  + graphMargin.bottom)
            .append('g')
            .attr('transform', ` translate( ${graphMargin.left}, ${graphMargin.top} ) `);

        var lastDate = new Date(d3.max(data, (d) => d.date));
        lastDate.setMonth(lastDate.getMonth() + 1);

        // Calc scales
        var x = d3.scaleTime()
            .range([0, graphWidth])
            .domain([d3.min(data, (d) => d.date), lastDate]);
        var y = d3.scaleLinear()
            .range([graphHeight, 0])
            .domain([0, d3.max(data, (d) => d.value)]);

        svg.selectAll('rect').remove()
        svg.selectAll('rect')
            .data(data)
        .enter().append('rect')
        .style('fill', '#A4C639')
        .attr('x', (d) => x(d.date))
        .attr('width', (graphWidth + graphMargin.left + graphMargin.right) / data.length)
        .attr('y', (d) => y(d.value))
        .attr('height', (d) => graphHeight - y(d.value));

    var xAxis = d3.axisBottom()
        .scale(x)
        .tickFormat(d3.timeFormat('%Y-%m'));

    var yAxis = d3.axisLeft()
        .scale(y)
        .tickSize(-graphWidth)
        .ticks(3);

    svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', `translate( 0, ${graphHeight} )`)
        .call(xAxis);
    svg.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

    svg.selectAll('label')
        .data(data)
        .enter()
        .append('text')
        .attr('class', 'label')
        .style('fill', '#A4C639')
        .attr('x', (d) => x(d.date))
        .attr('y', (d) => y(d.value))
        .attr('dx', '-.7em')
        .attr('dy', '-.35em')
        .text((d) => d.value);

    }

    function drawDonut(data) {
        // Get the donut element and add an svg into it
        if(d3.select('#today').selectAll('#svg')) {
            d3.select('#svg').remove()
        }
        var donutSVG = d3.select('#today').append('svg')
            .attr('id', 'svg')
            .attr('width', DONUT_WIDTH)
            .attr('height', DONUT_HEIGHT)

        // Add an svg group and move down from top left so we are centered nicely
        var donut = donutSVG.append('g')
            .attr('transform', `translate( ${DONUT_WIDTH / 2}, ${DONUT_HEIGHT / 2} )`)

        // Define an arc to draw with D3
        var arc = d3.arc()
            .outerRadius(DONUT_RADIUS - 10)
            .innerRadius(DONUT_RADIUS - 60);

        // Define pie piece size, D3 pie() returns object with angles
        var pie = d3.pie()
            .value( (d) => d.value )

        // Define projection of data set to arc paths
        var g = donut.selectAll('.arc')
            .data(pie(groupByCategory(data)))
            .enter().append('g')
            .attr('class', 'arc');

        // Select the data to be projected onto each arc path
        g.append('path')
            .attr('d', arc)
            .style('fill', (d) => color(d.data.key))
            .on('click', catClicked);
    }

    drawChart(data)
    drawDonut(data)

</script>

</body>
</html>
